define(['jquery','fotorama/fotorama','underscore','matchMedia','mage/template','text!mage/gallery/gallery.html','uiClass','mage/translate'],function($,fotorama,_,mediaCheck,template,galleryTpl,Class,$t){'use strict';var getMainImageIndex=function(data){var mainIndex;if(_.every(data,function(item){return _.isObject(item);})){mainIndex=_.findIndex(data,function(item){return item.isMain;});}
return mainIndex>0?mainIndex:0;},getTranslate=function(el){var slideTransform=$(el).attr('style').split(';');slideTransform=$.map(slideTransform,function(style){style=style.trim();if(style.startsWith('transform: translate3d')){return style.match(/transform: translate3d\((.+)px,(.+)px,(.+)px\)/);}
return false;});return slideTransform.filter(Boolean);},_toNumber=function(str){var type=typeof(str);if(type==='string'){return parseInt(str);}else{return str;}};return Class.extend({defaults:{settings:{},config:{},startConfig:{}},isTouchEnabled:(function(){return'ontouchstart'in document.documentElement;})(),initialize:function(config,element){var self=this;this._super();_.bindAll(this,'_focusSwitcher');if(this.isTouchEnabled){config.options.arrows=false;if(config.fullscreen){config.fullscreen.arrows=false;}}
config.options.width=_toNumber(config.options.width);config.options.height=_toNumber(config.options.height);config.options.thumbwidth=_toNumber(config.options.thumbwidth);config.options.thumbheight=_toNumber(config.options.thumbheight);config.options.swipe=true;this.config=config;this.settings={$element:$(element),$pageWrapper:$('body>.page-wrapper'),currentConfig:config,defaultConfig:_.clone(config),fullscreenConfig:_.clone(config.fullscreen),breakpoints:config.breakpoints,activeBreakpoint:{},fotoramaApi:null,isFullscreen:false,api:null,data:_.clone(config.data)};config.options.ratio=config.options.width / config.options.height;config.options.height=null;$.extend(true,this.startConfig,config);this.initGallery();this.initApi();this.setupBreakpoints();this.initFullscreenSettings();this.settings.$element.on('mouseup','.fotorama__stage__frame',function(){if(!$(this).parents('.fotorama__shadows--left, .fotorama__shadows--right').length&&!$(this).hasClass('fotorama-video-container')){self.openFullScreen();}});if(this.isTouchEnabled){this.settings.$element.on('tap','.fotorama__stage__frame',function(){var translate=getTranslate($(this).parents('.fotorama__stage__shaft'));if(translate[1]==='0'&&!$(this).hasClass('fotorama-video-container')){self.openFullScreen();self.settings.$pageWrapper.hide();}});}
this.settings.$gallery.on('fotorama:show fotorama:showend',function(e,fotorama,extra){var navDotEl=$('.fotorama__nav__shaft').find('.fotorama__nav__frame--dot');$('.fotorama-total-items').find('.current').text(fotorama.activeIndex+1);if(fotorama.size>5){if(fotorama.activeIndex>=3&&fotorama.activeIndex<=fotorama.size-2){navDotEl.removeClass('small');navDotEl.removeClass('medium');navDotEl.eq(fotorama.activeIndex+2).addClass('small');navDotEl.eq(fotorama.activeIndex+1).addClass('medium');navDotEl.eq(fotorama.activeIndex-3).addClass('small');navDotEl.eq(fotorama.activeIndex-2).addClass('medium');navDotEl.hide();navDotEl.slice(fotorama.activeIndex-3,fotorama.activeIndex+3).css('display','flex');}else if(fotorama.activeIndex===0){navDotEl.hide().slice(0,5).css('display','flex');navDotEl.removeClass('medium').eq(3).addClass('medium');navDotEl.removeClass('small').eq(4).addClass('small');}}else{navDotEl.removeClass('small');navDotEl.removeClass('medium');if(fotorama.activeIndex>=fotorama.size-2){navDotEl.first().addClass('small');navDotEl.eq(1).addClass('medium');}else{navDotEl.last().addClass('small');navDotEl.eq(fotorama.size-2).addClass('medium');}}
navDotEl.eq(fotorama.activeIndex).hasClass('medium')&&navDotEl.eq(fotorama.activeIndex).removeClass('medium');navDotEl.eq(fotorama.activeIndex).hasClass('small')&&navDotEl.eq(fotorama.activeIndex).removeClass('small');});},openFullScreen:function(){this.settings.fotoramaApi.requestFullScreen();this.settings.$fullscreenIcon.css({opacity:1,visibility:'visible',display:'block'});},cancelFullScreen:function(){this.settings.fotoramaApi.toggleFullScreen();},toResize:function(){$('.toSmall').trigger('click');var minHeight=$('.fotorama__stage__frame.fotorama__active').find('img.fotorama__img--full').css('min-height'),minWidth=$('.fotorama__stage__frame.fotorama__active').find('img.fotorama__img--full').css('min-width');$('.fotorama__stage__frame.fotorama__active').find('img.fotorama__img--full.fotorama__img--zoommable').css({width:minWidth,height:minHeight});if(this.isDisabled()){$('.toBig').addClass('_disabled');}else{$('.toBig').removeClass('_disabled');}},isDisabled:function(){var parentWidth=$('.fotorama__stage__frame.fotorama__active').find('img.fotorama__img--full').width(),imgNaturalWidth=$('.fotorama__stage__frame.fotorama__active').find('img.fotorama__img--full')[0].naturalWidth,result='';if(parentWidth>imgNaturalWidth){result=true;}else{result=false;}
return result;},showSlide:function(slideDir){var self=this;if(this.settings.api.fotorama){this.settings.fotoramaApi.show(slideDir);}else{this.settings.fotoramaApi.show(slideDir);}
setTimeout(function(){if(self.isDisabled()){$('.toBig').addClass('_disabled');$('.toSmall').addClass('_disabled');$('.toClose').addClass('_disabled');}else{$('.toBig').removeClass('_disabled');$('.toSmall').addClass('_disabled');$('.toClose').addClass('_disabled');}},1000);},initFullscreenSettings:function(){var settings=this.settings,self=this;settings.$gallery=this.settings.$element.find('[data-gallery-role="gallery"]');settings.$fullscreenIcon=this.settings.$element.find('[data-gallery-role="fotorama__fullscreen-icon"]');settings.focusableStart=this.settings.$element.find('[data-gallery-role="fotorama__focusable-start"]');settings.focusableEnd=this.settings.$element.find('[data-gallery-role="fotorama__focusable-end"]');settings.closeIcon=this.settings.$element.find('[data-gallery-role="fotorama__fullscreen-icon"]');settings.addToCartButton=this.settings.$element.find('[data-gallery-role="add-to-cart"]');settings.fullscreenConfig.swipe=true;settings.$gallery.on('fotorama:fullscreenenter',function(){settings.closeIcon.show();settings.focusableStart.attr('tabindex','0');settings.focusableEnd.attr('tabindex','0');settings.focusableStart.bind('focusin',self._focusSwitcher);settings.focusableEnd.bind('focusin',self._focusSwitcher);settings.api.updateOptions(settings.defaultConfig.options,true);settings.api.updateOptions(settings.fullscreenConfig,true);dataLayer.push({event:'e_linkClick',linkPlacement:'gallery',linkID:'open'});if(!_.isEqual(settings.activeBreakpoint,{})&&settings.breakpoints){settings.api.updateOptions(settings.activeBreakpoint.options,true);}
settings.isFullscreen=true;if($('.product-info-main').find('.bv_reviews').length>0){$('.fotorama__product-info').find('.product-reviews').html($('.product-info-main').find('.bv_reviews').html())}
setTimeout(function(){$('.toClose').trigger('click');},800);$('.fotorama--fullscreen').find('.fotorama__nav__frame.fotorama__nav__frame--thumb').click(function(){setTimeout(function(){if(self.isDisabled()){$('.toBig').addClass('_disabled');}else{$('.toBig').removeClass('_disabled');}},1000)});var dynamicHtml="<span class='current'>"+(self.settings.fotoramaApi.activeIndex+1)+"</span>"+"<span class='of'>"+$t('of')+"</span>"+self.settings.fotoramaApi.size;settings.$gallery.on('fotorama:show fotorama:showend',function(e,fotorama,extra){$('.gallery-dynamic-pagination').find('span.current').html(fotorama.activeIndex+1);});$('.gallery-dynamic-pagination').html(dynamicHtml);var navWrapTop=$('.fotorama__fullscreen').find('.fotorama__product-info').height()+100;$('.fotorama-item.fotorama--fullscreen .fotorama__nav-wrap--vertical.fotorama__nav-wrap').css('top',navWrapTop+'px');});settings.$gallery.on('fotorama:fullscreenexit',function(){settings.closeIcon.hide();settings.focusableStart.attr('tabindex','-1');settings.focusableEnd.attr('tabindex','-1');settings.api.updateOptions(settings.defaultConfig.options,true);settings.focusableStart.unbind('focusin',this._focusSwitcher);settings.focusableEnd.unbind('focusin',this._focusSwitcher);settings.closeIcon.hide();if(!_.isEqual(settings.activeBreakpoint,{})&&settings.breakpoints){settings.api.updateOptions(settings.activeBreakpoint.options,true);}
settings.isFullscreen=false;settings.$element.data('gallery').updateOptions({swipe:true});});settings.addToCartButton.on('click',function(){$('.product-info-main').find('.product-add-form button.tocart').trigger('click');self.cancelFullScreen();});},_focusSwitcher:function(e){var target=$(e.target),settings=this.settings;if(target.is(settings.focusableStart)){this._setFocus('start');}else if(target.is(settings.focusableEnd)){this._setFocus('end');}},_setFocus:function(position){var settings=this.settings,focusableElements,infelicity;if(position==='end'){settings.$gallery.find(settings.closeIcon).focus();}else if(position==='start'){infelicity=3;focusableElements=settings.$gallery.find(':focusable');focusableElements.eq(focusableElements.length-infelicity).focus();}},initGallery:function(){var breakpoints={},self=this,settings=this.settings,config=this.config,sku=$.trim($(".product-info-stock-sku .product.attribute.sku .value").html()),productName=$.trim($(".page-title-wrapper.product .page-title .base").html()),isNotifyMe='false',addToCartTitle=$t('Add to Cart'),productId='',dataBvProductId=$('.product-info-main .bv_reviews').length?$('.product-info-main .bv_reviews').attr('data-bv-product-id'):'',notifyMeUrl='',suggestPrice=$.trim($('.product-info-main').find(' .price-suggest-price .price-container .price-label .price .price').text()),finalPrice=$.trim($('.product-info-main').find('.product-info-price .price-wrapper[data-price-type="finalPrice"] '+'.price').text()),savePrice=$.trim($('.product-info-main').find('span.save .price').text()),spanSave=$.trim($('.product-info-main').find('span.save').text()),showAddToCart=true,addToCartButtonElement='.product-add-form .tocart:visible',oosProductMessage='',spanPriceLength=$('.product-info-main').find('span.save').length,priceLength=$('.product-info-main').find('span.save .price').length,save='';if(spanPriceLength>0&&priceLength>0){save=$t('SAVE')+' '+savePrice;}else{save=spanSave;}
if(!finalPrice||finalPrice===''){finalPrice=$.trim($('.product-info-main').find('.product-info-price .price-wrapper[data-price-type="basePrice"] '+'.price').text());}
if(!finalPrice||finalPrice===''){finalPrice=$('.product-info-main .product-info-price .price-box.price-final_price '+'.minimal-price > .price-container.price-final_price  span.price-wrapper span.price').text();}
var pdpNotifyPopup=$('.pdp.oos-notify-popupButton');if($('#product-addtocart-button').length>0||$('form.product_addtocart_form').length>0){pdpNotifyPopup.hide();}else{if(pdpNotifyPopup.css('display')=='none'){pdpNotifyPopup.show();isNotifyMe='true';productId=pdpNotifyPopup.data('id');addToCartTitle=$t('Notify Me');notifyMeUrl=pdpNotifyPopup.data('url');}}
if(!$(addToCartButtonElement).length&&addToCartTitle===$t('Add to Cart')){showAddToCart=false;if($('.product-info-main .out-of-stock').length){oosProductMessage=$('.product-info-main .out-of-stock').html();}}
var tpl=template(galleryTpl,{clickToZoom:$t("Click to zoom"),next:$t('Next'),previous:$t('Previous'),sku:sku,productName:productName,suggestPrice:suggestPrice,savePrice:save,finalPrice:finalPrice,specialOffersTitle:$t("Special offers"),learnMore:$t("learn more"),addToCartTitle:addToCartTitle,isNotifyMe:isNotifyMe,productId:productId,dataBvProductId:dataBvProductId,notifyMeUrl:notifyMeUrl,showAddToCart:showAddToCart,oosProductMessage:oosProductMessage}),mainImageIndex;var toolbarHtml="";$('.fotorama--fullscreen').append();if(settings.breakpoints){_.each(_.values(settings.breakpoints),function(breakpoint){var conditions;_.each(_.pairs(breakpoint.conditions),function(pair){conditions=conditions?conditions+' and ('+pair[0]+': '+pair[1]+')':'('+pair[0]+': '+pair[1]+')';});breakpoints[conditions]=breakpoint.options;});settings.breakpoints=breakpoints;}
_.extend(config,config.options);config.options=undefined;config.click=false;config.breakpoints=null;settings.currentConfig=config;settings.$element.html(tpl);settings.$element.removeClass('_block-content-loading');settings.$elementF=$(settings.$element.children()[0]);settings.$elementF.fotorama(config);settings.fotoramaApi=settings.$elementF.data('fotorama');$.extend(true,config,this.startConfig);mainImageIndex=getMainImageIndex(config.data);if(mainImageIndex){this.settings.fotoramaApi.show(mainImageIndex);}
$('.fotorama__arr, .fotorama__arr__arr, .fotorama__dot').click(function(){self.toHideVideoIndicator()});$('.toBig').click(function(){$('.fotorama__zoom-in').trigger('click');var naturalWidth=$('.fotorama__stage__frame.fotorama__active').find('img.fotorama__img--full')[0].naturalWidth,imgWidth=$('.fotorama__stage__frame.fotorama__active').find('img.fotorama__img--full').width();if(imgWidth<naturalWidth){$('.toBig').removeClass('_disabled');}else{$('.toBig').addClass('_disabled');}
if(self.isDisabled()){$('.toSmall').addClass('_disabled');$('.toClose').addClass('_disabled');}else{$('.toSmall').removeClass('_disabled');$('.toClose').removeClass('_disabled');}});$('.toSmall').click(function(){$('.fotorama__zoom-out').trigger('click');var minWidth=$('.fotorama__stage__frame.fotorama__active').find('img.fotorama__img--full').css('min-width'),imgWidth=$('.fotorama__stage__frame.fotorama__active').find('img.fotorama__img--full').width();minWidth=parseFloat(minWidth);if(isNaN(minWidth)){minWidth=$('.fotorama__stage__frame.fotorama__active').width();}
if(imgWidth<=minWidth){$('.toSmall').addClass('_disabled');$('.toClose').addClass('_disabled');}else{$('.toSmall').removeClass('_disabled');$('.toClose').removeClass('_disabled');}
if(self.isDisabled()){$('.toBig').addClass('_disabled');}else{$('.toBig').removeClass('_disabled');}});$('.toLeft').click(function(){self.showSlide('<');});$('.toRight').click(function(){self.showSlide('>');});settings.$element.find('.toClose').click(function(){self.toResize();$('.toSmall').addClass('_disabled');$('.toClose').addClass('_disabled');});var tranY=0;if($('.fotorama__nav-wrap--vertical').find('.fotorama__nav__shaft').height()<=$('.fotorama-item.fotorama--fullscreen .fotorama__nav--thumbs').height()){settings.$element.find('.fotorama__thumb__arr').hide()}else{settings.$element.find('.fotorama__thumb__arr').show()}
settings.$element.find('.fotorama__thumb__arr').click(function(){var navShaft=$('.fotorama__nav-wrap--vertical').find('.fotorama__nav__shaft');if($(this).attr('aria-label')==='Previos'){if(tranY<=_toNumber(-navShaft.height())+config.options.thumbheight){$(this).addClass('disabled');tranY=0}else{tranY=tranY-config.options.thumbheight-20;$('.fotorama__nav-wrap--vertical').find('.fotorama__nav__shaft').css({transform:'translate3d(0px, '+tranY+'px, 0px)'});$(this).removeClass('disabled');}}else{if(tranY>=_toNumber(-navShaft.height())){$(this).addClass('disabled');tranY=0}else{tranY=tranY+config.options.thumbheight+20;$('.fotorama__nav-wrap--vertical').find('.fotorama__nav__shaft').css({transform:'translate3d(0px, '+tranY+'px, 0px)'})
$(this).removeClass('disabled');}}});var galleryArray=self.showGalleryCount();$('.fotorama-total-items').find('.current').text(galleryArray.currentItem);$('.fotorama-total-items').find('.total').text(galleryArray.totalItems);$('.fotorama__product-info').find('button.oos-notify-popupButton-gallery').click(function(){self.cancelFullScreen();pdpNotifyPopup.trigger('click');});var dotTotals=self.settings.fotoramaApi.size,navDotEl=$('.fotorama__nav__shaft').find('.fotorama__nav__frame--dot');if(dotTotals>5){navDotEl.slice(0,5).css('display','flex');navDotEl.eq(3).addClass('medium');navDotEl.eq(4).addClass('small');}else{navDotEl.css('display','flex');navDotEl.last().addClass('small');navDotEl.eq(dotTotals-2).addClass('medium');}},toHideVideoIndicator:function(){if(this.settings.fotoramaApi.activeFrame.type==='video'){$('.fotorama__zoom-indicator').hide();}else{$('.fotorama__zoom-indicator').show();}},setupBreakpoints:function(){var pairs,settings=this.settings,config=this.config,startConfig=this.startConfig,triggeredBreakpoints=0,isTouchEnabled=this.isTouchEnabled;if(_.isObject(settings.breakpoints)){pairs=_.pairs(settings.breakpoints);_.each(pairs,function(pair){mediaCheck({media:pair[0],entry:function(){$.extend(true,config,_.clone(startConfig));settings.api.updateOptions(settings.defaultConfig.options,true);if(settings.isFullscreen){settings.api.updateOptions(settings.fullscreenConfig,true);}
if(isTouchEnabled){settings.breakpoints[pair[0]].options.arrows=false;if(settings.breakpoints[pair[0]].options.fullscreen){settings.breakpoints[pair[0]].options.fullscreen.arrows=false;}}
settings.api.updateOptions(settings.breakpoints[pair[0]].options,true);$.extend(true,config,settings.breakpoints[pair[0]]);settings.activeBreakpoint=settings.breakpoints[pair[0]];},exit:function(){$.extend(true,config,_.clone(startConfig));settings.api.updateOptions(settings.defaultConfig.options,true);if(settings.isFullscreen){settings.api.updateOptions(settings.fullscreenConfig,true);}
settings.activeBreakpoint={};}});});}},initApi:function(){var settings=this.settings,config=this.config,api={fotorama:settings.fotoramaApi,last:function(){settings.fotoramaApi.show('>>');},first:function(){settings.fotoramaApi.show('<<');},prev:function(){settings.fotoramaApi.show('<');},next:function(){settings.fotoramaApi.show('>');},seek:function(index){if(_.isNumber(index)&&index!==0){if(index>0){index-=1;}
settings.fotoramaApi.show(index);}},updateOptions:function(configuration,isInternal){var $selectable=$('a[href], area[href], input, select, textarea, button, iframe, object, embed, *[tabindex], *[contenteditable]').not('[tabindex=-1], [disabled], :hidden'),fotorama=settings.fotoramaApi,$focus=$(':focus'),index;if(_.isObject(configuration)){$selectable.each(function(number){if($(this).is($focus)){index=number;}});if(this.isTouchEnabled){configuration.arrows=false;}
configuration.click=false;configuration.breakpoints=null;if(!isInternal){!_.isEqual(settings.activeBreakpoint,{}&&settings.brekpoints)?$.extend(true,settings.activeBreakpoint.options,configuration):settings.isFullscreen?$.extend(true,settings.fullscreenConfig,configuration):$.extend(true,settings.defaultConfig.options,configuration);}
$.extend(true,settings.currentConfig.options,configuration);settings.fotoramaApi.setOptions(settings.currentConfig.options);if(_.isNumber(index)){$selectable.eq(index).focus();}}},updateData:function(data){if(_.isArray(data)){settings.fotoramaApi.load(data);$.extend(false,settings,{data:data,defaultConfig:data});$.extend(false,config,{data:data});}},returnCurrentImages:function(){var images=[];_.each(this.fotorama.data,function(item){images.push(_.omit(item,'$navThumbFrame','$navDotFrame','$stageFrame','labelledby'));});return images;},updateDataByIndex:function(index,item){settings.fotoramaApi.spliceByIndex(index,item);}};settings.$element.data('gallery',api);settings.api=settings.$element.data('gallery');settings.$element.trigger('gallery:loaded');},showGalleryCount:function(){var galleryArray={};galleryArray.currentItem=this.settings.fotoramaApi.activeIndex+1;galleryArray.totalItems=this.settings.fotoramaApi.size;return galleryArray;}});});