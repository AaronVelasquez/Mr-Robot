define(['jquery','Magento_Customer/js/customer-data','mage/translate','HPOLS_Catalog/js/popup','mage/template','Magento_Catalog/js/price-utils','swipeSlider','stellarGlobal','HPOLS_Catalog/js/add-recommended-to-cart','jquery/ui','loader'],function($,customerData,$t,$p,$temp,priceUtils,Swiper,stellarGlobal,addRecommendedToCart){"use strict";$.widget('mage.popupAddToCart',{options:{processStart:null,processStop:null,bindSubmit:true,minicartSelector:'[data-block="minicart"]',messagesSelector:'[data-placeholder="messages"]',productStatusSelector:'.stock.available',addToCartButtonSelector:'.action.tocart',addToCartButtonDisabledClass:'disabled',addToCartButtonTextWhileAdding:'',addToCartButtonTextAdded:'',addToCartButtonTextDefault:'',carePackAddToCartUrl:'',carePackAddToCarDone:false,addRecommendedIng:false,disablePopup:0,newVersionPopup:0,addRecommendProductToCartUrl:window.BASE_URL+'dynamicdiscount/cart/add',stellarGlobal:new stellarGlobal(),isBundleProduct:null,isContinueShopping:true,productCarePackMappingUrl:window.BASE_URL+'checkout/cart/productcarepackmapping'},_create:function(){if(this.options.bindSubmit){this._bindSubmit();}
this._bindEvent();},_bindEvent:function(){var self=this;$(document).off('click','.catalog-product-popup._show button.continue-shopping');$(document).on('click','.catalog-product-popup._show button.continue-shopping',function(){$('.catalog-product-popup._show .modal-inner-wrap .action-close').trigger('click');self._rebindTabClickEvent();});$(document).off('click','.catalog-product-popup .modal-inner-wrap .action-close');$(document).on('click','.catalog-product-popup .modal-inner-wrap .action-close',function(){self._rebindTabClickEvent();})
$(document).off('click','.catalog-product-popup._show button.view-cart');$(document).on('click','.catalog-product-popup._show button.view-cart',function(){addRecommendedToCart._binRecommendedAddToCart($(this),'toCart');});$(document).off('click',".catalog-product-popup._show .product-item a");$(document).on('click',".catalog-product-popup._show .product-item a",function(){addRecommendedToCart._binRecommendedAddToCart($(this),'');});},_rebindTabClickEvent:function(){$(document).off('click','.related-title-tabs li').on('click','.related-title-tabs li',function(){$(this).closest('ul').siblings('.active-tabs').text($(this).find('.related-attribute-title').text());if($(window).width()<768){$(this).closest('ul').slideUp();}
$(this).removeClass('hover').addClass('active').siblings().removeClass('active');if($(this).hasClass('recommend')){$('.recommended-products').show();$('.other-recommend-product').hide();}else{$('.recommended-products').hide();if($(this).parents('#product-related-links').length>0){$('#product-related-links').find('.other-recommend-product').eq($(this).attr('data-related-index')).show().siblings('.other-recommend-product').hide();$('#product-related-links').find('.other-recommend-product').eq($(this).attr('data-related-index')).find('.swiper-button-prev').addClass('swiper-button-disabled');$('#product-related-links').find('.other-recommend-product').eq($(this).attr('data-related-index')).find('.swiper-button-next').removeClass('swiper-button-disabled');}else{$('.other-recommend-product').eq($(this).attr('data-related-index')).show().siblings('.other-recommend-product').hide();$('.other-recommend-product').eq($(this).attr('data-related-index')).find('.swiper-button-prev').addClass('swiper-button-disabled');$('.other-recommend-product').eq($(this).attr('data-related-index')).find('.swiper-button-next').removeClass('swiper-button-disabled');}}});},_bindSubmit:function(){var self=this;this.element.unbind('submit');this.element.on('submit',function(e){e.preventDefault();self.submitForm($(this));});},removeSelected:function(doAction){var self=this,el=$('.catalog-product-popup .selected-products-list'),_parent=el.parents('.selected-products-popup');$(doAction).unbind('click').bind('click',function(){$('.'+$(this).attr('id')).removeClass('added-action adding-action').find('span').text($t('Add Item'));$(this).closest('.added-item').remove();var slideLength=el.find('.added-item').length;if($(window).width()>768){if(slideLength>2){self.productSwiper(slideLength,2,'.selected-products-popup .swiper','.selected-product-swiper-button-prev','.selected-product-swiper-button-next');}else{_parent.find(".swiper").removeClass('swiper-container-horizontal');}}else{if(slideLength>1){self.productSwiper(slideLength,2,'.selected-products-popup .swiper','.selected-product-swiper-button-prev','.selected-product-swiper-button-next');}else{_parent.find(".swiper").removeClass('swiper-container-horizontal');}}
$('.add-to-cart-popup-title').html($t("%1 ITEMS ADDED <span>TO YOUR BASKET </span>").replace('%1',slideLength));})},productSwiper:function(slideLength,slidesPerView,container,prev,next){var swipeConfig={slidesPerView:slidesPerView,spaceBetween:16,observable:true,observeSlideChildren:true,navigation:{nextEl:next,prevEl:prev,},breakpoints:{320:{slidesPerView:1.2,},769:{slidesPerView:1.2,},},};if(slideLength<=slidesPerView){swipeConfig.simulateTouch=false;}
new Swiper(container,swipeConfig);},addRecommendToCart:function(doAction){var slideLength=0,slidesPerView=2,self=this,container='.catalog-product-popup._show .selected-products-list',$parent=$(container).parents('.selected-products-popup');$(doAction).each(function(){$(this).unbind('click');$(this).click(function(){var _this=$(this);if(!$(this).hasClass('added-action')){$('.catalog-product-popup').find('.swiper').show();$(this).addClass('adding-action').siblings('input').prop('checked',true);$(this).find('span').text($t('Remove Item'));$(this).closest('.item').siblings().find('input').prop('checked',false);$(this).closest('.item').siblings().find('label.add-item').removeClass('added-action');var productDataStr=$(this).closest('.product-item-info').attr('data-product'),productData=JSON.parse(productDataStr),purchaseMessage=$(this).closest('.product-item-details').find('.purchase-by-purchase-message').attr('data-msg');productData['format_price']=priceUtils.formatPrice(productData.price);productData['purchase_message']=purchaseMessage;productData['url']=productData['url']==='#'?'javaScript:;':productData['url'];var alt=$(this).closest('.product-item-info').find('.product-image-photo').attr('alt');productData['alt']=alt?alt:productData['name'];var template=$temp('#dynamic-discount-template');var templateHtml=template({data:productData});slideLength=$(container).find('.added-item').length+1;$(container).prepend(templateHtml);if($(window).width()>768){if(slideLength>slidesPerView){self.productSwiper(slideLength,2.2,'.selected-products-popup .swiper','.selected-product-swiper-button-prev','.selected-product-swiper-button-next');}else{}}else{if(slideLength>1){self.productSwiper(slideLength,1.2,'.selected-products-popup .swiper','.selected-product-swiper-button-prev','.selected-product-swiper-button-next');}else{}}
var productId=_this.parents('.product-item-info').attr('data-product-id');self.removeSelected('.remove-btn#id-'+productId);}else{var productId=_this.parents('.product-item-info').attr('data-product-id');$('.recommended-product-popup').find('#id-'+productId).trigger('click');_this.removeClass('added-action');}
setTimeout(function(){if(_this.hasClass('adding-action')){_this.removeClass('adding-action').addClass('added-action');}},3000);$('.add-to-cart-popup-title').html($t("%1 ITEMS ADDED <span>TO YOUR BASKET </span>").replace('%1',$(container).find('.added-item').length));});});},isLoaderEnabled:function(){return this.options.processStart&&this.options.processStop;},submitForm:function(form){var addToCartButton,self=this;if(form.has('input[type="file"]').length&&form.find('input[type="file"]').val()!==''){self.element.off('submit');addToCartButton=$(form).find(this.options.addToCartButtonSelector);addToCartButton.prop('disabled',true);addToCartButton.addClass(this.options.addToCartButtonDisabledClass);form.submit();}else{if(form.data('type')==='configurable'){if(!form.validate().form()){return false;}
var attributeHtml='';$('.product-info-main .swatch-attribute').each(function(key,ele){attributeHtml+='<div class="attribute"><span class="attribute-label">'+$(ele).find('.swatch-attribute-label').text()+':</span>';attributeHtml+='<span class="attribute-value">'+$(ele).find('.swatch-attribute-selected-option').text()+'</span></div>';});$('.configurable-attribute').html(attributeHtml);}
if(form.data('type')==='bundle'){if(form.find(".bundle-product-configurable-options .fieldset .field.option.required").length>0){if(!form.validate().form()){return false;}}}
self.ajaxSubmit(form);}},closeMessage:function(container){$(container).click(function(){$(this).closest('div').remove();})},ajaxSubmit:function(form){var self=this;$(self.options.minicartSelector).trigger('contentLoading');self.disableAddToCartButton(form);var carePackData=self.getCarePackData(form);window.ajaxSubmitToCartProcess=1;if(carePackData){self.carePackSubmit(carePackData);}
$.ajaxSetup({showLoader:true});if($('.catalog-product_compare-index').length>0){$('body').loader('show');}
$.ajax({url:form.attr('action'),data:form.serialize(),type:'post',dataType:'json',beforeSend:function(){if(self.isLoaderEnabled()){$('body').trigger(self.options.processStart);}},success:function(res){if(self.isLoaderEnabled()){$('body').trigger(self.options.processStop);}
if(typeof dataLayer!=="undefined"&&res.dataLayerProducts){var dataLayerProductData=JSON.parse(res.dataLayerProducts);var pageType=$('.product.info.detailed').children('.product.data.items').find('.data.item.title.active').children('a').attr('href');var cookieOfferId=self.getCookie('spos_offer_id'),offerId='';if(!_.isEmpty(cookieOfferId)&&typeof cookieOfferId!=="undefined"&&cookieOfferId!=='null'){offerId=cookieOfferId;}
var reg=/related|offer/;if(!reg.test(pageType)||window.location.hash=='#product.view.tab.related.links'){if(dataLayerProductData.id){let productPositionObj=$('[name='+dataLayerProductData.id+'_product_position]');if(productPositionObj.length>0){let productPosition=productPositionObj.val();if(productPosition){dataLayerProductData.position=parseInt(productPosition);}}}
var list=self.getListName();if(typeof dataLayerProductData.list!=='undefined'){delete dataLayerProductData.list;}
dataLayer.push({'event':'e_addToCart','offerID':offerId,'ecommerce':{'currencyCode':dlCurrencyCode,'add':{'newCart':true,'detail':{'actionField':{"list":list}},'products':[dataLayerProductData]}}});}}
self.options.isBundleProduct=$(form).data("type")==="bundle";if(res.messages){$(self.options.messagesSelector).text(res.messages);}
if(res.isAddToCart){var sections=['cart'];customerData.invalidate(sections);customerData.reload(sections,true);}
if(res.minicart){$(self.options.minicartSelector).replaceWith(res.minicart);$(self.options.minicartSelector).trigger('contentUpdated');}
if(res.product&&res.product.statusText){$(self.options.productStatusSelector).removeClass('available').addClass('unavailable').find('span').text(res.product.statusText);}
if(form.find('.popup-addtocart-button').length>0||form.find('.bundle-popup-view-cart').length>0){if(self.options.newVersionPopup===0){$p.copyForm(form.parent('.product-add-form'),'');}else{var slideLength=$('.recommended-products-swiper .swiper-slide').length;var carePackLength=form.parent('.product-add-form').find('.box-tocart .product-care-options #product-care-option option').length;if(slideLength>0||carePackLength>1){$p.copyForm($('.simple-popup-main-content'),'catalog-product-popup catalog-popup-hasRelated');}
if(slideLength>0){self.options.stellarGlobal.swiperItem('.catalog-product-popup .recommended-products',16,3.5);}else{var callback=self.showErrorOnTitle(res,'.popup-noRelated-content');$p.copyForm($('.popup-noRelated-content'),'catalog-popup-noRelated catalog-product-popup',callback);}
var recommendedProductsPopup=$('.catalog-product-popup').find('.product-dynamic-discount');if(recommendedProductsPopup.length){if(form.parent('.product-add-form').find('.product-dynamic-discount').hasClass('hide')){form.parent('.product-add-form').find('.product-dynamic-discount').removeClass('hide');if(!recommendedProductsPopup.hasClass('hide')){recommendedProductsPopup.addClass('hide');}}else{recommendedProductsPopup.removeClass('hide');}}
var tabsEl='.recommended-product-popup .related-title-tabs';new Swiper(tabsEl+' .swiper',{slidesPerView:"auto",spaceBetween:0,observable:true,observeSlideChildren:true,navigation:{nextEl:tabsEl+' .swiper-button-next',prevEl:tabsEl+' .swiper-button-prev',},pagination:{el:tabsEl+' .swiper-pagination',type:'fraction',formatFractionTotal:function(number){if(number>1){$(tabsEl).find('ul').css({'justify-content':'flex-start'});}else{$(tabsEl).find('ul').css({'justify-content':'center'});}},},});}
self.addRecommendToCart('.recommended-product-popup label.add-item');if($('.catalog-product-popup').find('.other-recommend-product').length<1){$('.catalog-product-popup').find('.recommended-products').after($('.other-recommend-product').clone(true));}
let relatedTitleTabsClass=$(window).width()<768?'.mobile-related-title-tabs':'.related-title-tabs',relatedTitleActiveTabSelector=$('.catalog-product-popup '+relatedTitleTabsClass).find('li.active');if(relatedTitleActiveTabSelector.hasClass('recommend')){$('.catalog-product-popup').find('.recommended-products').show();$('.catalog-product-popup').find('.other-recommend-product').hide();}else{let currentEL=$('.catalog-product-popup').find('.other-recommend-product').eq(relatedTitleActiveTabSelector.data('related-index')),currentELId=currentEL.attr('id');currentEL.show();self.options.stellarGlobal.swiperItem('.catalog-product-popup #'+currentELId,16,3.5);}
$(document).off('click','.related-title-tabs li').on('click','.related-title-tabs li',function(){$(this).addClass('active').siblings().removeClass('active').removeClass('hover');if(!$(this).hasClass('recommend')){$('.catalog-product-popup').find('.recommended-products').hide();var currentEL=$('.catalog-product-popup').find('.other-recommend-product').eq($(this).attr('data-related-index')),currentELId=currentEL.attr('id');currentEL.show();currentEL.siblings('.other-recommend-product').hide();if($('.modal-popup._show').hasClass('catalog-product-popup')){self.options.stellarGlobal.swiperItem('.catalog-product-popup #'+currentELId,16,3.5);}
self.addRecommendToCart('.catalog-product-popup._show .recommended-product-popup button.related-add-to-bubble');}else{$('.catalog-product-popup').find('.recommended-products').show();self.options.stellarGlobal.swiperItem('.catalog-product-popup .recommended-products',16,3.5);$('.catalog-product-popup').find('.other-recommend-product').hide();}});}else if(['simple','bundle'].includes(form.data('type'))){if(self.options.disablePopup!==1){var callback=null;var allowXmlView=['catalog_category_view','catalogsearch_result_index','hawksearch_result_index'];if(allowXmlView.includes(form.find('button').data('view'))){callback=function(){var addedItemCount=$('.catalog-product-popup._show .simple-popup-main-content '+'.selected-products-popup').find('.added-item').length;$('.add-to-cart-popup-title').html($t("%1 ITEMS ADDED <span>TO YOUR BASKET </span>").replace('%1',addedItemCount));}}
if(res.error){callback=self.showErrorOnTitle(res,'.simple-popup-main-content');}else{$('.simple-popup-main-content .add-to-cart-popup-error-title').hide();$('.simple-popup-main-content .add-to-cart-popup-title').show();}
if($('.catalog-product_compare-index').length>0){callback=function(){let addedItemCount=$('.catalog-product-popup._show .simple-popup-main-content '+'.selected-products-popup').find('.added-item').length;$('.add-to-cart-popup-title').html($t("%1 ITEMS ADDED <span>TO YOUR BASKET </span>").replace('%1',addedItemCount));};}
$p.addPopup(form.find('button'),callback);}else if($('.catalog-product_compare-index').length>0){$('body').loader('hide');}}
if(form.data('type')==='configurable'){$p.configurablePopup(form.parent('.product-add-form'));}
var carePackProductsPopup=$('.catalog-product-popup').find('.product-care-info'),carePackOptionsValue=$("#product-care-option");if(typeof self.options.carePackAddToCarDone!=="undefined"&&self.options.carePackAddToCarDone){carePackOptionsValue.val(0);carePackProductsPopup.addClass('hidden');self.options.carePackAddToCarDone=false;}else{if(carePackProductsPopup.hasClass('hidden')){carePackProductsPopup.removeClass('hidden');}}
self.enableAddToCartButton(form);$('.modals-wrapper .product-add-form.simple form > .product-care-info').insertAfter('.modals-wrapper .product-add-form.simple form > .simple-popup-main-content .bundle-popup-main');$('.product-info-main .product-care-info #product-care-option').trigger('change');self.handleAddToCartSuccess(res);}});},handleAddToCartSuccess:function(data){},getListName:function(){var name=pageName5.toLowerCase();if(name==='pdp'){return'pdp page';}else if(name==='search'){return'search results'}else{return name;}},getCookie:function(cookieName){var cookie=" "+document.cookie;var search=" "+cookieName+"=";var setStr='null';var offset=0;var end=0;if(cookie.length>0){offset=cookie.indexOf(search);if(offset!==-1){offset+=search.length;end=cookie.indexOf(";",offset);if(end===-1){end=cookie.length;}
setStr=unescape(cookie.substring(offset,end));}}
return(setStr);},disableAddToCartButton:function(form){var addToCartButtonTextWhileAdding=this.options.addToCartButtonTextWhileAdding||$t('Adding...');var addToCartButton=$(form).find(this.options.addToCartButtonSelector);this.options.addToCartButtonTextDefault=addToCartButton.find('span').text();addToCartButton.addClass(this.options.addToCartButtonDisabledClass);addToCartButton.find('span').text(addToCartButtonTextWhileAdding);addToCartButton.attr('title',addToCartButtonTextWhileAdding);},getCarePackData:function(form){var data="",carePackLength=$('.product-care-options #product-care-option option').length,carePackVal=$('.product-care-options #product-care-option option:selected').val();if(carePackLength&&carePackVal!=="0"){data=carePackVal+"|1";}
return data;},carePackSubmit:function(carePackData){var self=this;var carePackUrl=self.options.carePackAddToCartUrl;var carePackProduct=$("#product-care-option-included").val();$.ajax({url:carePackUrl,type:'POST',dataType:'json',data:{'products':carePackData,'carePackProduct':carePackProduct},async:false,success:function(response){if(response.isAddToCart){self.afterCarePackSubmit();self.options.carePackAddToCarDone=true;}}});},enableAddToCartButton:function(form){var addToCartButtonTextAdded=this.options.addToCartButtonTextAdded;var self=this,addToCartButton=$(form).find(this.options.addToCartButtonSelector);addToCartButton.addClass('success').find('span').text(addToCartButtonTextAdded);addToCartButton.attr('title',addToCartButtonTextAdded);setTimeout(function(){var addToCartButtonTextDefault=$t('Add to cart');addToCartButton.removeClass(self.options.addToCartButtonDisabledClass);addToCartButton.removeClass('success');addToCartButton.find('span').text(addToCartButtonTextDefault);addToCartButton.attr('title',addToCartButtonTextDefault);},500);},showErrorOnTitle:function(res,container){var callback=function(){$(container).find('.add-to-cart-popup-error-title').hide();$(container).find('.add-to-cart-popup-title').show();};if(!res.error){return callback;}
callback=function(){$(container).find('.add-to-cart-popup-error-title').html(res.error).show();$(container).find('.add-to-cart-popup-title').hide();}
return callback;},afterCarePackSubmit:function(){var mainProductSku=$('.product-social-links').find('.sku').text();var carePackSku=$('.carepack-list').find(".actived .option input[name='carepack']").val();$('.carepack-list li').removeClass("actived").eq(0).addClass("actived");$(".selected-carepack").html($('.carepack-list li').eq(0).find(".product-name").text());$("#product-care-option-included").val('');if(mainProductSku==null||mainProductSku==undefined||mainProductSku==""){return false;}
if(carePackSku==null||carePackSku==undefined||carePackSku==""){return false;}
var self=this;var productCarePackMappingUrl=self.options.productCarePackMappingUrl;var selectMapping={mainProductSku:mainProductSku,carePackSku:carePackSku}
$.ajax({url:productCarePackMappingUrl,type:'POST',dataType:'json',data:{'selectMapping':selectMapping},success:function(response){$.ajaxSetup({showLoader:false});if(response.code!==200){if(response.message){alert({content:response.message});}}
return false;},error:function(response){$.ajaxSetup({showLoader:false});if(response.messages){alert({content:response.message});}}})}});return $.mage.popupAddToCart;});